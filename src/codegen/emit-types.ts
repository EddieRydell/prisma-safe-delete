import type { ParsedModel, ParsedSchema } from '../dmmf-parser.js';

/**
 * Generates the SafePrismaClient type definitions
 * @param schema - The parsed Prisma schema
 * @param clientImportPath - The import path for PrismaClient (e.g., '../client' or '@prisma/client')
 */
export function emitTypes(schema: ParsedSchema, clientImportPath: string): string {
  const lines: string[] = [];

  lines.push('/* eslint-disable */');
  lines.push('// @ts-nocheck');
  lines.push('// Auto-generated by prisma-safe-delete');
  lines.push('// Do not edit this file manually');
  lines.push('');
  lines.push(`import type { PrismaClient, Prisma } from '${clientImportPath}';`);
  lines.push('');

  // Generate model-specific types
  for (const model of schema.models) {
    lines.push(...emitModelTypes(model));
    lines.push('');
  }

  // Generate the main SafePrismaClient type
  lines.push(...emitSafePrismaClientType(schema));

  return lines.join('\n');
}

function emitModelTypes(model: ParsedModel): string[] {
  const lines: string[] = [];
  const name = model.name;
  const lowerName = toLowerFirst(name);

  if (model.isSoftDeletable) {
    // Soft-deletable model gets modified delegate type
    lines.push(`/** Soft-delete enabled delegate for ${name} */`);
    lines.push(`export type Safe${name}Delegate = Omit<`);
    lines.push(`  PrismaClient['${lowerName}'],`);
    lines.push(`  'delete' | 'deleteMany'`);
    lines.push(`> & {`);
    lines.push(`  /** Soft delete a single ${name} record */`);
    lines.push(`  softDelete: (args: Prisma.${name}DeleteArgs) => Promise<Prisma.${name}GetPayload<{}>>;`);
    lines.push(`  /** Soft delete multiple ${name} records */`);
    lines.push(`  softDeleteMany: (args: Prisma.${name}DeleteManyArgs) => Promise<Prisma.BatchPayload>;`);
    lines.push(`  /** Hard delete a single ${name} record (permanent) */`);
    lines.push(`  hardDelete: (args: Prisma.${name}DeleteArgs) => Promise<Prisma.${name}GetPayload<{}>>;`);
    lines.push(`  /** Hard delete multiple ${name} records (permanent) */`);
    lines.push(`  hardDeleteMany: (args: Prisma.${name}DeleteManyArgs) => Promise<Prisma.BatchPayload>;`);
    lines.push(`};`);
  } else {
    // Non-soft-deletable model keeps original type
    lines.push(`/** Standard delegate for ${name} (no soft-delete) */`);
    lines.push(`export type Safe${name}Delegate = PrismaClient['${lowerName}'];`);
  }

  return lines;
}

function emitSafePrismaClientType(schema: ParsedSchema): string[] {
  const lines: string[] = [];

  lines.push('/** Type-safe Prisma client with soft-delete support */');
  lines.push('export interface SafePrismaClient {');

  // Add model delegates
  for (const model of schema.models) {
    const lowerName = toLowerFirst(model.name);
    lines.push(`  ${lowerName}: Safe${model.name}Delegate;`);
  }

  lines.push('');
  lines.push('  // Prisma client methods');
  lines.push("  $connect: PrismaClient['$connect'];");
  lines.push("  $disconnect: PrismaClient['$disconnect'];");
  lines.push("  $on: PrismaClient['$on'];");
  lines.push("  $transaction: PrismaClient['$transaction'];");
  lines.push("  $use: PrismaClient['$use'];");
  lines.push("  $extends: PrismaClient['$extends'];");
  lines.push("  $queryRaw: PrismaClient['$queryRaw'];");
  lines.push("  $executeRaw: PrismaClient['$executeRaw'];");
  lines.push("  $queryRawUnsafe: PrismaClient['$queryRawUnsafe'];");
  lines.push("  $executeRawUnsafe: PrismaClient['$executeRawUnsafe'];");
  lines.push('');
  lines.push('  /** Access to underlying Prisma client for escape hatches */');
  lines.push('  $prisma: PrismaClient;');
  lines.push('');
  lines.push('  /** Query including soft-deleted records */');
  lines.push('  $includingDeleted: IncludingDeletedClient;');
  lines.push('');
  lines.push('  /** Query only soft-deleted records */');
  lines.push('  $onlyDeleted: OnlyDeletedClient;');
  lines.push('}');
  lines.push('');

  // Generate IncludingDeletedClient type
  lines.push('/** Client that includes soft-deleted records in queries */');
  lines.push('export interface IncludingDeletedClient {');
  for (const model of schema.models) {
    const lowerName = toLowerFirst(model.name);
    lines.push(`  ${lowerName}: PrismaClient['${lowerName}'];`);
  }
  lines.push('}');
  lines.push('');

  // Generate OnlyDeletedClient type
  lines.push('/** Client that queries only soft-deleted records */');
  lines.push('export interface OnlyDeletedClient {');
  for (const model of schema.models) {
    if (model.isSoftDeletable) {
      const lowerName = toLowerFirst(model.name);
      lines.push(`  ${lowerName}: Pick<PrismaClient['${lowerName}'], 'findMany' | 'findFirst' | 'findUnique' | 'count'>;`);
    }
  }
  lines.push('}');

  return lines;
}

function toLowerFirst(str: string): string {
  const first = str.charAt(0);
  return first.toLowerCase() + str.slice(1);
}
